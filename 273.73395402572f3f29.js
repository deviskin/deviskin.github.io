(()=>{"use strict";class p{constructor(e,t){this.workerId=e,this.message=t}static builder(){return new p(-1,null)}setWorkerId(e){return this.workerId=e,this}setMessage(e){return this.message=e,this}}let T=(()=>{class i{constructor(t){this.type=t,this.id=0,this.callbackId=-1,this.id=i.newId()}static newId(){return i.staticId++}setCallbackId(t){return this.callbackId=t,this}}return i.staticId=0,i})(),S=(()=>{class i extends T{constructor(t){super(i.TYPE),this.pageLoadedFrom=t}static builder(){return new i("")}setPageLoadedFrom(t){return this.pageLoadedFrom=t,this}}return i.TYPE="SetupWorkerRequest",i})();class d extends T{}let x=(()=>{class i extends d{constructor(t,s){super(i.TYPE),this.libraryRef=t,this.libraryType=s}static builder(){return new i("","")}setLibraryRef(t){return this.libraryRef=t,this}setLibraryType(t){return this.libraryType=t,this}}return i.TYPE="LibraryInfoRequest",i})(),E=(()=>{class i extends d{constructor(t,s,r){super(i.TYPE),this.libraryType=t,this.bookRef=s,this.loadBooksEnabled=r}static builder(){return new i("","",!0)}setLibraryType(t){return this.libraryType=t,this}setBookRef(t){return this.bookRef=t,this}setLoadBooksEnabled(t){return this.loadBooksEnabled=t,this}}return i.TYPE="BookInfoRequest",i})(),C=(()=>{class i extends d{constructor(t,s,r){super(i.TYPE),this.libraryType=t,this.bookRef=s,this.languages=r}static builder(){return new i("","",[])}setLibraryType(t){return this.libraryType=t,this}setBookRef(t){return this.bookRef=t,this}setLanguages(t){return this.languages=t,this}addLanguage(t){return this.languages.push(t),this}}return i.TYPE="BookRequest",i})(),B=(()=>{class i extends d{constructor(t){super(i.TYPE),this.pages=t}static builder(){return new i([])}setBookPages(t){return this.pages=t,this}addBookPage(t){return this.pages.push(t),this}}return i.TYPE="PagesRequest",i})(),M=(()=>{class i extends d{constructor(t){super(i.TYPE),this.pages=t}static builder(){return new i([])}setPages(t){return this.pages=t,this}addPage(t){return this.pages.push(t),this}}return i.TYPE="PagesResponse",i})();class b{constructor(e,t,s){this.bookRef=e,this.path=t,this.content=s}static builder(){return new b("","","")}setBookRef(e){return this.bookRef=e,this}setPath(e){return this.path=e,this}setContent(e){return this.content=e,this}}let N=(()=>{class i extends d{constructor(t){super(i.TYPE),this.metaBooks=t}static builder(){return new i([])}setMetaBooks(t){return this.metaBooks=t,this}addMetaBook(t){return this.metaBooks.push(t),this}}return i.TYPE="BookResponse",i})(),O=(()=>{class i extends d{constructor(t,s,r){super(i.TYPE),this.bookRef=t,this.metaContent=s,this.loadBooksEnabled=r}static builder(){return new i("","",!0)}setBookRef(t){return this.bookRef=t,this}setMetaContent(t){return this.metaContent=t,this}setLoadBooksEnabled(t){return this.loadBooksEnabled=t,this}}return i.TYPE="BookInfoResponse",i})(),H=(()=>{class i extends d{constructor(t,s){super(i.TYPE),this.libraryRef=t,this.metaContent=s}static builder(){return new i("","")}setLibraryRef(t){return this.libraryRef=t,this}setMetaContent(t){return this.metaContent=t,this}}return i.TYPE="LibraryInfoResponse",i})();class f{static merge(e,t){if(!e&&!t)return"";if(!e)return t;if(!t)return e;let s=e.endsWith("/"),r=t.startsWith("/"),n=e;return s!=r?n+=t:s?n+=r?t.substring(1):t:n?n+="/"+t:n=t,n}}class v{static dtr(e,t){for(var s=t>=0?t:47,r=new ArrayBuffer(e.length-1),n=new Uint8Array(r),a=s,h=0;h<e.length;++h){var g=255&(e[h]^a);h>0&&(n[h-1]=g),a=255&(a+g^5)}return n}static fromByteArray(e){let t="";for(let s=0;s<e.length;s+=2)t+=String.fromCharCode(e[s+1]<<8|e[s]);return t}}const R="2.0.243",D=[{id:"deviskin",name:"Deviskin",nameSortOrder:"Deviskin",link:"http://deviskin.github.io"}];class l{constructor(e,t,s,r,n,a,h,c,g){this.id=e,this.name=t,this.routes=s,this.routeEnabled=r,this.applicationEnabled=n,this.applicationHidden=a,this.applicationLogoText=h,this.libraryType=c,this.libraryRef=g}static builder(){return new l("","",[],!1,!1,!1,"","prod","book")}setId(e){return this.id=e,this}setName(e){return this.name=e,this}setRoutes(e){return this.routes=e,this}setRouteEnabled(e){return this.routeEnabled=e,this}setApplicatioinEnabled(e){return this.applicationEnabled=e,this}setApplicationLogoText(e){return this.applicationLogoText=e,this}setLibraryType(e){return this.libraryType=e,this}setLibraryRef(e){return this.libraryRef=e,this}enable(e=!0){return this.routeEnabled=e,this.applicationEnabled=e,this}hide(e=!0){return this.applicationHidden=e,this}disable(){return this.routeEnabled=!1,this.applicationEnabled=!1,this}}class o{constructor(e,t,s,r,n,a=null,h=null){this.link=e,this.name=t,this.shape=s,this.hasBadge=r,this.hasAlert=n,this.onClick=a,this.isActive=h}static builder(){return new o("","","",!1,!1)}setIsActive(e){return this.isActive=e,this}setOnClick(e){return this.onClick=e,this}setLink(e){return this.link=e,this}setName(e){return this.name=e,this}setShape(e){return this.shape=e,this}setHasBadge(e){return this.hasBadge=e,this}setHasAlert(e){return this.hasAlert=e,this}runOnClick(){this.onClick&&this.onClick(this)}}class m extends class U{constructor(){this.version="",this.applicationId="memorial",this.applicationName="Memorial",this.developers=D,this.production=!0,this.platform="Web",this.relativeCacheService=!0,this.serviceAPIHost="",this.redirectToServerAfterItIsReadyAdress="",this.portAutoDetection=!0,this.portAutoIncrementValue=0,this.defaultRoute="/compiler",this.coding=!0,this.showOldVersions=!0,this.themeName="blue",this.serverType="rest",this.applications=[],this.addApplication(l.builder().setId("about").setName("\u041e \u0441\u0430\u0439\u0442\u0435").setRoutes([o.builder().setLink("about").setName("\u041e \u0441\u0430\u0439\u0442\u0435").setShape("home")]).hide()).addApplication(l.builder().setId("d3examples").setName("\u041f\u0440\u0438\u043c\u0435\u0440\u044b D3").setApplicationLogoText("D3|\u043f\u0440\u0438\u043c\u0435\u0440\u044b").setRoutes([o.builder().setLink("main-test").setName("\u041c\u043e\u043b\u0435\u0431\u0435\u043d").setShape("calendar"),o.builder().setLink("memorials-pages-editor").setName("\u0417\u0430\u043f\u0438\u0441\u043a\u0438").setShape("event"),o.builder().setLink("d3examples").setName("\u041f\u0440\u0438\u043c\u0435\u0440\u044b D3").setShape("image"),o.builder().setLink("dynamic-components-examples").setName("\u041f\u0440\u0438\u043c\u0435\u0440\u044b \u0414\u041a\u043e\u043c\u043f\u043e\u043d\u0435\u043d\u0442").setShape("blocks-group"),o.builder().setLink("help").setName("\u041f\u043e\u043c\u043e\u0449\u044c").setShape("help"),o.builder().setLink("tests").setName("\u0422\u0435\u0441\u0442\u044b").setShape("check-circle")]).hide()).addApplication(l.builder().setId("d3Dexamples").setName("\u041f\u0440\u0438\u043c\u0435\u0440\u044b 3D").setApplicationLogoText("Three.JS|\u043f\u0440\u0438\u043c\u0435\u0440\u044b").setRoutes([o.builder().setLink("d3Dexamples").setName("Three 3D").setShape("scroll")]).hide()).addApplication(l.builder().setId("books").setName("\u041a\u043d\u0438\u0433\u0438").setLibraryType("prod").setLibraryRef("biblia").setRoutes([o.builder().setLink("books").setName("\u041a\u043d\u0438\u0433\u0438").setShape("book")])).addApplication(l.builder().setId("memorial").setName("\u041f\u043e\u043c\u044f\u043d\u043d\u0438\u043a").setLibraryType("mprod").setLibraryRef("ps").setRoutes([o.builder().setLink("memorial").setName("\u041f\u043e\u043c\u044f\u043d\u043d\u0438\u043a").setShape("note")])).addApplication(l.builder().setId("calculator").setName("\u041a\u0430\u043b\u044c\u043a\u0443\u043b\u044f\u0442\u043e\u0440").setLibraryType("cprod").setLibraryRef("calc").setApplicationLogoText("\u041c\u0410\u0422\u0410\u041d|\u043a\u0430\u043b\u044c\u043a\u0443\u043b\u044f\u0442\u043e\u0440").setRoutes([o.builder().setLink("calculator").setName("\u041a\u0430\u043b\u044c\u043a\u0443\u043b\u044f\u0442\u043e\u0440").setShape("calculator")]).hide()).addApplication(l.builder().setId("calendar").setName("\u041a\u0430\u043b\u0435\u043d\u0434\u0430\u0440\u044c").setLibraryType("clndrprod").setLibraryRef("clndr").setRoutes([o.builder().setLink("calendar").setName("\u041a\u0430\u043b\u0435\u043d\u0434\u0430\u0440\u044c").setShape("calendar")]).hide()).addApplication(l.builder().setId("compiler").setName("\u041a\u043e\u043c\u043f\u0438\u043b\u044f\u0442\u043e\u0440").setLibraryType("compprod").setLibraryRef("comp").setApplicationLogoText("C-Js|\u043a\u043e\u043c\u043f\u0438\u043b\u044f\u0442\u043e\u0440").setRoutes([o.builder().setLink("compiler").setName("\u041a\u043e\u043c\u043f\u0438\u043b\u044f\u0442\u043e\u0440").setShape("bug")]).hide()).addApplication(l.builder().setId("scheduler").setName("\u0420\u0430\u0441\u043f\u0438\u0441\u0430\u043d\u0438\u0435").setLibraryType("schprod").setLibraryRef("sch").setRoutes([o.builder().setLink("scheduler").setName("\u0420\u0430\u0441\u043f\u0438\u0441\u0430\u043d\u0438\u0435").setShape("alarm-clock")])).setVersion("BV."+R),this.afterConstruct()}addApplication(e){if(null!=this.applications.find(t=>t.id==e.id))throw new Error(`\u041f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u0435 "${e.id}" \u0443\u0436\u0435 \u0441\u0443\u0449\u0435\u0441\u0442\u0432\u0443\u0435\u0442.`);return this.applications.push(e),this}setVersion(e){return this.version=e,this}setProduction(e){return this.production=e,this}setPlatform(e){return this.platform=e,this}setRelativeCacheService(e){return this.relativeCacheService=e,this}setServiceAPIHost(e){return this.serviceAPIHost=e,this}setRedirectToServerAfterItIsReadyAdress(e){return this.redirectToServerAfterItIsReadyAdress=e,this}setPortAutoDetection(e){return this.portAutoDetection=e,this}setPortAutoIncrementValue(e){return this.portAutoIncrementValue=e,this}setDefaultRoute(e){return this.defaultRoute=e,this}setServerType(e){return this.serverType=e,this}setCoding(e){return this.coding=e,this}setShowOldVersions(e){return this.showOldVersions=e,this}afterConstruct(){}}{afterConstruct(){super.afterConstruct(),this.setVersion("WPR."+R).setProduction(!0).setServiceAPIHost("").setRedirectToServerAfterItIsReadyAdress("").setPortAutoDetection(!0).setPortAutoIncrementValue(0).setDefaultRoute("/help").setServerType("memory"),this.applications.forEach((e,t,s)=>e.enable())}static builder(){return new m}}const u=m.builder();class y{constructor(e,t){this.id=e,this.handler=t}static builder(){return new y(-1,()=>{})}setId(e){return this.id=e,this}setHandler(e){return this.handler=e,this}}class X{constructor(){this.id=1,this.handlers=new Map,this.targetHandlers=new Map,this.messagesToTarget=new Map,this.messagesTimeoutMs=18e4}newId(){return this.id++}putMessage(e){let t=e.target,s=this.messagesToTarget.get(t);return null==s&&(s=[]),s.push(e),s=this.removeOld(s),s?this.messagesToTarget.set(t,s):this.messagesToTarget.delete(t),this}getMessages(e,t=!0){let s=this.messagesToTarget.get(e),r=this.removeOld(s);return null==s&&t&&this.messagesToTarget.delete(e),r}removeAllOld(){let e=[];return this.messagesToTarget.forEach((t,s,r)=>{e.push(s)}),e.forEach(t=>{this.getMessages(t,!1)}),this}removeOld(e){if(void 0===e)return;let t=Date.now(),s=e.findIndex(n=>n.time+this.messagesTimeoutMs>t),r=e;return s>0&&(r=e.splice(0,s)),r}sendMessage(e){this.handlers.forEach((s,r,n)=>{s(e)});let t=this.targetHandlers.get(e.target);t&&t.forEach(s=>{s.handler(e)})}addHandler(e){let t=this.newId();this.handlers.set(t,e);let s=this;return{unsubscribe(){s.removeHandler(t)}}}addTargetHandler(e,t){let s=this.newId(),r=this.targetHandlers.get(e);null==r&&(r=[],this.targetHandlers.set(e,r)),r.push(y.builder().setId(s).setHandler(t));let n=this;return{unsubscribe(){n.removeTargetHandler(e,s)}}}removeAllTargetHandlers(e){return this.targetHandlers.delete(e),this}removeHandler(e){this.handlers.delete(e)}removeTargetHandler(e,t){let s=this.targetHandlers.get(e);if(s){let r=s.filter((n,a,h)=>n.id!=t);r.length?this.targetHandlers.set(e,r):this.targetHandlers.delete(e)}}}let L=new class F extends class q{constructor(e=null){this.messageSender=e,this.requests=new Map}send(e,t){return this.messageSender&&(this.requests.set(t.type,t),this.messageSender(e,t)),this}post(e,t){return this}runAll(e,t,s){let r=0,n=()=>{if(r>=e.length)return void(s&&s(!0));let a=e[r++];t(a,h=>{h?n():s&&s(!1)})};n()}}{constructor(e=null){super(e),this.cacheService=null}setCacheService(e){return this.cacheService=e,this}post(e,t){switch(t.type){case x.TYPE:this.onLibraryInfoRequest(e,t);break;case E.TYPE:this.onBookInfoRequest(e,t);break;case C.TYPE:this.onBookRequest(e,t);break;case B.TYPE:this.onPagesRequest(e,t);break;default:throw new Error(`Unknown message type: ${t.type}.`)}return this}onLibraryInfoRequest(e,t){let s=H.builder().setCallbackId(t.id);t.libraryRef?this.loadLibraryInfo(t,s,t.libraryType+"/"+t.libraryRef+".library.txt",r=>{this.send(e,s)}):this.send(e,s)}loadLibraryInfo(e,t,s,r=null){let n=this.cacheService.getRestPoint(s,null);this.cacheService.getTextRestcallUrl(n,a=>{t.setMetaContent(a||"").setLibraryRef(e.libraryRef),r&&r(!!a)})}onBookInfoRequest(e,t){let s=O.builder().setCallbackId(t.id);t.bookRef?this.loadBookInfo(t,s,t.libraryType+"/"+t.bookRef+".book.txt",r=>{this.send(e,s)}):this.send(e,s)}loadBookInfo(e,t,s,r=null){let n=this.cacheService.getRestPoint(s,null);this.cacheService.getTextRestcallUrl(n,a=>{t.setMetaContent(a||"").setBookRef(e.bookRef),r&&r(!!a)})}onBookRequest(e,t){let s=N.builder().setCallbackId(t.id),r=t.languages.map(n=>n);r.length||r.push("CS","Sinodal"),r=r.map(n=>f.merge("/"+t.libraryType,t.bookRef+"_"+n+"/index.txt")),t.bookRef?this.runAll(r,(n,a)=>{this.loadBookPath(t,s,n,a)},n=>{this.send(e,s)}):this.send(e,s)}loadBookPath(e,t,s,r=null){let n=this.cacheService.getRestPoint(s,null);this.cacheService.getTextRestcallUrl(n,a=>{t.addMetaBook(b.builder().setBookRef(e.bookRef).setPath(s).setContent(a||"")),r&&r(!!a)})}onPagesRequest(e,t){let s=M.builder().setCallbackId(t.id);this.runAll(t.pages,(r,n)=>{let a=this.findPathPrefix(r.bookPath),h=this.cacheService.getRestPoint(f.merge(a,r.bookPage),null);this.cacheService.getTextRestcallUrl(h,c=>{s.addPage(c||""),n(!0)})},r=>{this.send(e,s)})}findPathPrefix(e){let t=e.lastIndexOf("/");return e.substring(0,t)}}((i,e)=>{postMessage(i?p.builder().setWorkerId(i.workerId).setMessage(e):e)}),P=new class ${constructor(){this.cache=new Map,this.environment=u,this.themeName=u.themeName,this.serviceAPIHost=u.serviceAPIHost,this.redirectToServerAfterItIsReadyAdress=u.redirectToServerAfterItIsReadyAdress,this.portAutoDetection=u.portAutoDetection,this.portAutoIncrementValue=u.portAutoIncrementValue,this.messageBus=new X,this.alerts=[],this.upperMenuEnabled=!0,this.pageLoadedFrom="",this.authId="",this.authIdKey="authId",this.authBody="",this.baseHref="",this.waitingIOOperationCount=0,this.waitingIOOperationValue=0,this.waitingIOOperationValueMax=100,this.outletOnly=!1,this.autoLoginApplication=!0,this.defaultApplication="",this.defaultLoginType="login",this.showType=this.defaultLoginType,this.enableDefaultPersons=!0,this.coding=u.coding,this.showOldVersions=u.showOldVersions,"undefined"!=typeof pageLoadedFrom&&this.setPageLoadedFrom(pageLoadedFrom),this.runPortAutoDetection(),this.setupBaseHref()}isShowLogin(){return this.showType==this.defaultLoginType}isShowNormal(){return"normal"==this.showType}setShowNormal(){return this.showType="normal",this}setShowLogin(e=null){return null!=e&&(this.autoLoginApplication=e),this.showType=this.defaultLoginType,this}get version(){return this.environment.version}get developerId(){let e="";return this.environment.developers.forEach(t=>{e=e+(e?"_":"")+t.id}),e}get developerName(){let e="";return this.environment.developers.forEach(t=>{e=e+(e?", ":"")+t.name}),e}get developerNameSortOrder(){let e="";return this.environment.developers.forEach(t=>{e=e+(e?", ":"")+t.nameSortOrder}),e}get developerLink(){return this.environment.developers[0].link}setPageLoadedFrom(e,t=!1){return this.pageLoadedFrom=e,t&&this.runPortAutoDetection(),this.setupBaseHref(),this}setupBaseHref(){let e=this.pageLoadedFrom;e.endsWith("/")&&(e=e.substring(0,e.length-1)),this.baseHref=e}runPortAutoDetection(){this.portAutoDetection&&(this.serviceAPIHost=this.doPortAutoDetection(this.serviceAPIHost?this.serviceAPIHost:this.pageLoadedFrom),this.redirectToServerAfterItIsReadyAdress=this.doPortAutoDetection(this.redirectToServerAfterItIsReadyAdress))}doPortAutoDetection(e){const t=e.lastIndexOf(":");if(t<0)return e;let s="";for(let a=t+1;a<e.length&&"0123456789".indexOf(e.charAt(a))>=0;++a)s+=e.charAt(a);return isNaN(+s)?e:e.substring(0,t)+":"+(+location.port+u.portAutoIncrementValue)+e.substring(t+1+s.length,e.length)}addAlert(e){e.setConfig(this),this.alerts.push(e)}removeAlert(e){const t=this.alerts.findIndex((s,r,n)=>s===e);t>=0&&this.alerts.splice(t,1)}isPlatformAndroid(){return"Android"===this.environment.platform}isPlatformWeb(){return"Web"===this.environment.platform}isPlatform(e){return this.environment.platform===e}isRelativeCacheService(){return this.environment.relativeCacheService}isRestServerType(){return"rest"===this.environment.serverType}isMemoryServerType(){return"memory"===this.environment.serverType}isServerType(e){return this.environment.serverType===e}isRedTheme(){return"red"===this.themeName}isBlueTheme(){return"blue"===this.themeName}isTheme(e){return this.themeName===e}isWaitingIO(){return this.waitingIOOperationCount>0}incWaitingIO(){return this.waitingIOOperationCount++}decWaitingIO(){return this.waitingIOOperationCount--}clearWaitingIO(){this.waitingIOOperationCount=0}post(e,t=0){setTimeout(()=>{e()},t)}getApplication(){let e=null;return this.environment.applications.forEach(t=>{t.id==this.defaultApplication&&(e=t)}),e}getApplicationByNameOrNull(e){let t=null;return this.environment.applications.forEach(s=>{s.name==e&&(t=s)}),t}getSingleAppOrNull(){let e=null,t=this.environment.applications.filter(s=>s.applicationEnabled&&!s.applicationHidden);return 1==t.length&&(e=t[0]),e}};L.setCacheService(new class Y{constructor(e,t="/static"){this.config=e,this.sRestPoint=t,this.textCache=new Map,this.waitingTextCache=new Map}get coding(){return this.config.coding}get restPoint(){return this.coding?"/staticb":this.sRestPoint}getRestPoint(e,t,s=null){const r=this.config.isRelativeCacheService()||this.config.isMemoryServerType()?this.config.baseHref:this.config.serviceAPIHost;return f.merge(f.merge(t||r,null!=s?s:this.restPoint),e)}completeOnDone(e,t){let s=this.waitingTextCache.get(e);s&&(s.forEach(r=>{this.config.post(()=>{r&&r(t)})}),this.waitingTextCache.delete(e))}getTextRestcallUrl(e,t){if(this.coding){if(this.textCache.has(e)){let s=this.textCache.get(e);if(null!=s)return void this.config.post(()=>{t&&t(s)})}return this.waitingTextCache.has(e)?void(t&&this.waitingTextCache.get(e).push(t)):(t&&this.waitingTextCache.set(e,[t]),this.getBinRestcallUrlRaw(e,s=>{if(s){let r=new Uint8Array(s),n=v.fromByteArray(r);this.completeOnDone(e,n)}else t&&t(null)}))}return this.getTextRestcallUrlRaw(e,t)}getTextRestcallUrlRaw(e,t){if(this.textCache.has(e)){let r=this.textCache.get(e);if(null!=r)return void this.config.post(()=>{t&&t(r)})}if(this.waitingTextCache.has(e))t&&this.waitingTextCache.get(e).push(t);else{t&&this.waitingTextCache.set(e,[t]);var s=new XMLHttpRequest;s.onload=()=>{if(t){let r=4===s.readyState&&200===s.status?s.responseText:null;null!=r?this.textCache.set(e,r):this.textCache.delete(e),this.completeOnDone(e,r)}},s.open("get",e,!0),s.send()}}getBinRestcallUrlRaw(e,t){let s=e;if(this.coding){let n=s.lastIndexOf(".");n>=0&&(s=s.substring(0,n)+".bin")}var r=new XMLHttpRequest;r.onload=()=>{if(t){let a=new Uint8Array(4===r.readyState&&200===r.status?r.response:null),h=v.dtr(a,-1);t&&t(h)}},r.open("get",s,!0),r.responseType="arraybuffer",r.send()}}(P)),addEventListener("message",({data:i})=>{let e=i;if("string"==typeof e.message){const t=`worker response to ${i}`;postMessage(p.builder().setWorkerId(e.workerId).setMessage(t))}else e.message.type===S.TYPE?P.setPageLoadedFrom(e.message.pageLoadedFrom,!0):L.post(e,e.message)})})();